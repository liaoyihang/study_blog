---
title: 虚拟Dom
titleTemplate: Vue
---
# 虚拟 Dom
本文将介绍虚拟 **Dom 的基本概念**、**为什么需要虚拟 Dom**、以及**它如何转换成真实 Dom**。

## 什么是 Dom
**Dom 是文档对象模型（Document Object Model）**，它将 web 页面与到脚本或编程语言连接起来。通常是指 JavaScript，但将 HTML、SVG 或 XML 文档建模为对象并不是 JavaScript 语言的一部分。**DOM 模型用一个逻辑树来表示一个文档，树的每个分支的终点都是一个节点 (node)，每个节点都包含着对象 (objects)**。DOM 的方法 (methods) 让你可以用特定方式操作这个树，用这些方法你可以改变文档的结构、样式或者内容。节点可以关联上事件处理器，一旦某一事件被触发了，那些事件处理器就会被执行。

简而言之，**在 JavaScript 中，Dom 是用来描述节点的一个对象（object）**。这个对象上有非常多的成员，用于描述这个节点或关联事件。

## 什么是虚拟 Dom
**虚拟 Dom 的本质也是一个 JavaScript 的对象（object）**，用于描述一个节点或关联事件，与真实 Dom 不同的是，虚拟 Dom 的成员非常少，取自真实 Dom 中较为常用的成员，例如：tag、children、parent 等。

## 为什么需要虚拟 Dom
在 Vue中，渲染视图会调用 render 函数，**这种渲染不仅发生在组件创建时，同时发生在视图依赖的数据更新时**。如果在渲染时，直接使用真实 DOM，由于真实 DOM 的创建、更新、插入等操作会带来大量的性能损耗，从而就会极大的降低渲染效率。
 
Vue 团队做过性能对比，结果如下：
| 方案 | 初始性能 | 更新性能 | 可维护性 | 心智负担 |
| :---: | :---: | :---: | :---: | :---: | 
| 原生 JS   | 高   | 中等   |  差 |  大   | 
| 虚拟 Dom  | 中等 |  高  |  高 |  小大 | 
| innerHTML | 差   | 差   |  差 |  中等 | 

**虚拟 Dom 的出现，就是为了最小化找到差异的性能开销，让其最小化而出现的，这也是 Vue 他们在保证可维护性的前提下，最优性能的尝试**。

因此，Vue 在渲染时，使用虚拟 Dom 来替代真实 Dom，**主要为解决渲染效率的问题**。

## 虚拟 Dom 是如何转换为真实 Dom 的
在一个组件实例首次被渲染时，它先生成虚拟 Dom 树，然后根据虚拟 Dom 树创建真实 Dom，并把真实 Dom 挂载到页面中合适的位置，此时，每个虚拟 Dom 便会对应一个真实的 Dom。

如果一个组件受响应式数据变化的影响，需要重新渲染时，它仍然会重新调用 render 函数，创建出一个新的虚拟 Dom 树，**用新树和旧树对比，通过对比，Vue 会找到最小更新量**，然后更新必要的虚拟 Dom 节点，最后，这些更新过的虚拟节点，会去修改它们对应的真实 Dom，保证了对真实 Dom 达到最小的改动。

## 虚拟 Dom 是如何被创建
Vue 框架中有一个 compile 模块，它主要负责将模板转换为 render 函数，而 render 函数调用后将得到虚拟 Dom。编译的过程分三步：

1. 将模板字符串转换成为 AST
2. 将 AST 转成新的 AST
3. 将 AST 转换为 render 函数

详细的编译过程可以阅读 [模板语法原理](/guide/vue/template)

如果使用传统的引入方式，则编译时间发生在组件第一次加载时，这称之为运行时编译。如果是在 vue-cli 的默认配置下，编译发生在打包时，这称之为模板预编译。

编译是一个极其耗费性能的操作，预编译可以有效的提高运行时的性能，而且，由于运行的时候已不需要编译，vue-cli 在打包时会排除掉 Vue 中的 compile 模块，以减少打包体积。模板的存在，仅仅是为了让开发人员更加方便的书写界面代码。

Vue 最终运行的时候，最终需要的是 render 函数，而不是模板，因此，模板中的各种语法，在虚拟 Dom 中都是不存在的，它们都会变成虚拟 Dom 的配置。